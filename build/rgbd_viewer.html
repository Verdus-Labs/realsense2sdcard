<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RealSense RGB-D Data Viewer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f0f0f0;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background-color: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #333;
        padding-bottom: 20px;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
      }

      .frame-display {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
      }

      .frame-panel {
        text-align: center;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #fafafa;
      }

      .frame-panel h3 {
        margin: 0 0 15px 0;
        color: #333;
      }

      .frame-panel img {
        max-width: 500px;
        max-height: 400px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .metadata {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }

      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      input[type="range"] {
        width: 300px;
      }

      .frame-info {
        text-align: center;
        margin: 20px 0;
        font-size: 18px;
        font-weight: bold;
      }

      .status {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
      }

      .error {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
      }

      .success {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
      }

      .loading {
        color: #856404;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üé¨ RealSense RGB-D Data Viewer</h1>
        <p>Automatically loading from captured_data folder</p>
      </div>

      <div id="loadStatus" class="status loading">
        üîÑ Scanning captured_data folder for frames...
      </div>

      <div id="viewerSection" style="display: none">
        <div class="controls">
          <button id="prevBtn" onclick="previousFrame()">‚¨ÖÔ∏è Previous</button>
          <input
            type="range"
            id="frameSlider"
            min="0"
            max="0"
            value="0"
            onchange="goToFrame(this.value)"
          />
          <button id="nextBtn" onclick="nextFrame()">‚û°Ô∏è Next</button>
          <button onclick="playSlideshow()">‚ñ∂Ô∏è Play</button>
          <button onclick="stopSlideshow()">‚è∏Ô∏è Stop</button>
          <button onclick="refreshFrames()">üîÑ Refresh</button>
        </div>

        <div class="frame-info">
          <span id="frameInfo">Frame 1 of 0</span>
        </div>

        <div class="frame-display">
          <div class="frame-panel">
            <h3>üé® RGB Image</h3>
            <img
              id="rgbImage"
              src=""
              alt="RGB frame"
              onerror="this.style.display='none'"
            />
            <div id="rgbInfo"></div>
          </div>

          <div class="frame-panel">
            <h3>üìè Depth Image</h3>
            <img
              id="depthImage"
              src=""
              alt="Depth frame"
              onerror="this.style.display='none'"
            />
            <div id="depthInfo"></div>
          </div>
        </div>

        <div class="metadata">
          <h4>üìä Frame Metadata</h4>
          <div id="metadataContent">No metadata loaded</div>
        </div>
      </div>
    </div>

    <script>
      let frames = [];
      let currentFrame = 0;
      let slideshowInterval = null;

      // Auto-load frames when page loads
      window.addEventListener("load", () => {
        autoLoadFrames();
      });

      async function autoLoadFrames() {
        const loadStatus = document.getElementById("loadStatus");

        try {
          // Try to detect available frames by attempting to load frame files
          frames = await discoverFrames();

          if (frames.length === 0) {
            loadStatus.className = "status error";
            loadStatus.innerHTML = `
                        ‚ùå No frames found in captured_data folder<br>
                        <small>Make sure you have run the capture program and have PNG files in captured_data/rgb/ and captured_data/depth/</small>
                    `;
            return;
          }

          loadStatus.className = "status success";
          loadStatus.innerHTML = `‚úÖ Auto-loaded ${frames.length} frames from captured_data/`;

          // Setup viewer
          setupViewer();
          showFrame(0);
        } catch (error) {
          loadStatus.className = "status error";
          loadStatus.innerHTML = `
                    ‚ùå Error loading frames: ${error.message}<br>
                    <small>Make sure the HTML file is in the same directory as captured_data/</small>
                `;
        }
      }

      async function discoverFrames() {
        const discoveredFrames = [];

        // Try to load frames by guessing filenames
        // Start with frame 1 and keep going until we can't find more
        for (let i = 1; i <= 1000; i++) {
          // Max 1000 frames
          const frameNum = i.toString().padStart(6, "0");

          // Try to find any timestamp for this frame number
          const frame = await tryLoadFrame(frameNum);
          if (frame) {
            discoveredFrames.push(frame);
          } else {
            // If we can't find 5 consecutive frames, assume we're done
            if (i > 5 && discoveredFrames.length > 0) {
              const lastFound =
                discoveredFrames[discoveredFrames.length - 1].frameNumber;
              if (i - lastFound > 5) break;
            }
          }
        }

        return discoveredFrames.sort((a, b) => a.frameNumber - b.frameNumber);
      }

      async function tryLoadFrame(frameNum) {
        // Try different timestamp patterns - we'll use a wildcard approach
        const commonTimestamps = await findTimestampsForFrame(frameNum);

        for (const timestamp of commonTimestamps) {
          const rgbPath = `captured_data/rgb/frame_${frameNum}_${timestamp}_color.png`;
          const depthPath = `captured_data/depth/frame_${frameNum}_${timestamp}_depth.png`;
          const depthColorPath = `captured_data/depth/frame_${frameNum}_${timestamp}_depth_colorized.png`;

          // Check if RGB file exists
          if (await fileExists(rgbPath)) {
            return {
              frameNumber: parseInt(frameNum),
              timestamp: timestamp,
              rgb: rgbPath,
              depth: (await fileExists(depthPath)) ? depthPath : null,
              depthColorized: (await fileExists(depthColorPath))
                ? depthColorPath
                : null,
            };
          }
        }

        return null;
      }

      async function findTimestampsForFrame(frameNum) {
        // Since we can't list directory contents in browser, we'll try common timestamp patterns
        // This is a limitation of browser security - in a real app you'd have a server provide the file list

        // Try timestamps around current time (this is a hack, but works for recent captures)
        const now = Date.now();
        const timestamps = [];

        // Try timestamps from last 24 hours
        for (let i = 0; i < 24 * 60; i += 5) {
          // Every 5 minutes for last 24 hours
          const time = now - i * 60 * 1000;
          timestamps.push(time.toString());
        }

        return timestamps;
      }

      async function fileExists(path) {
        try {
          const response = await fetch(path, { method: "HEAD" });
          return response.ok;
        } catch {
          return false;
        }
      }

      function refreshFrames() {
        const loadStatus = document.getElementById("loadStatus");
        loadStatus.className = "status loading";
        loadStatus.innerHTML = "üîÑ Refreshing frames...";

        document.getElementById("viewerSection").style.display = "none";
        autoLoadFrames();
      }

      function setupViewer() {
        const viewerSection = document.getElementById("viewerSection");
        const frameSlider = document.getElementById("frameSlider");

        viewerSection.style.display = "block";
        frameSlider.max = frames.length - 1;

        updateControls();
      }

      function showFrame(index) {
        if (index < 0 || index >= frames.length) return;

        currentFrame = index;
        const frame = frames[index];

        // Update images
        const rgbImage = document.getElementById("rgbImage");
        const depthImage = document.getElementById("depthImage");

        if (frame.rgb) {
          rgbImage.src = frame.rgb;
          rgbImage.style.display = "block";
        } else {
          rgbImage.style.display = "none";
        }

        // Use colorized depth if available, otherwise raw depth
        const depthSrc = frame.depthColorized || frame.depth;
        if (depthSrc) {
          depthImage.src = depthSrc;
          depthImage.style.display = "block";
        } else {
          depthImage.style.display = "none";
        }

        // Update info
        document.getElementById("frameInfo").textContent = `Frame ${
          index + 1
        } of ${frames.length}`;
        document.getElementById("rgbInfo").textContent = frame.rgb
          ? "‚úÖ RGB Available"
          : "‚ùå No RGB";
        document.getElementById("depthInfo").textContent = depthSrc
          ? "‚úÖ Depth Available"
          : "‚ùå No Depth";

        // Update slider
        document.getElementById("frameSlider").value = index;

        updateControls();
      }

      function updateControls() {
        document.getElementById("prevBtn").disabled = currentFrame === 0;
        document.getElementById("nextBtn").disabled =
          currentFrame === frames.length - 1;
      }

      function previousFrame() {
        if (currentFrame > 0) {
          showFrame(currentFrame - 1);
        }
      }

      function nextFrame() {
        if (currentFrame < frames.length - 1) {
          showFrame(currentFrame + 1);
        }
      }

      function goToFrame(index) {
        showFrame(parseInt(index));
      }

      function playSlideshow() {
        if (slideshowInterval) return;

        slideshowInterval = setInterval(() => {
          if (currentFrame < frames.length - 1) {
            nextFrame();
          } else {
            stopSlideshow();
          }
        }, 200); // 5fps playback
      }

      function stopSlideshow() {
        if (slideshowInterval) {
          clearInterval(slideshowInterval);
          slideshowInterval = null;
        }
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        switch (e.key) {
          case "ArrowLeft":
            previousFrame();
            break;
          case "ArrowRight":
            nextFrame();
            break;
          case " ":
            e.preventDefault();
            if (slideshowInterval) {
              stopSlideshow();
            } else {
              playSlideshow();
            }
            break;
          case "r":
          case "R":
            refreshFrames();
            break;
        }
      });
    </script>
  </body>
</html>
